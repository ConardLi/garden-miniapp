<import src="../../../components/we-cropper/we-cropper.wxml"/>

<view class="container">
  <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
  <view class="step-indicator">
    <view class="step {{step >= 1 ? 'active' : ''}}">
      <view class="step-number">1</view>
      <view class="step-text">é€‰æ‹©ç…§ç‰‡</view>
    </view>
    <view class="step-line"></view>
    <view class="step {{step >= 2 ? 'active' : ''}}">
      <view class="step-number">2</view>
      <view class="step-text">æ™ºèƒ½æŠ å›¾</view>
    </view>
    <view class="step-line"></view>
    <view class="step {{step >= 3 ? 'active' : ''}}">
      <view class="step-number">3</view>
      <view class="step-text">è°ƒæ•´ç…§ç‰‡</view>
    </view>
  </view>

  <!-- æ­¥éª¤1ï¼šé€‰æ‹©å›¾ç‰‡å’Œæ ·å¼ -->
  <view class="step-1" wx:if="{{step === 1}}">
    <!-- å°ºå¯¸é€‰æ‹© -->
    <scroll-view scroll-x class="size-list">
      <view 
        wx:for="{{sizeList}}" 
        wx:key="id"
        class="size-item {{selectedSize.id === item.id ? 'active' : ''}}"
        data-size="{{item}}"
        bindtap="selectSize"
      >
        <view class="size-name">{{item.name}}</view>
        <view class="size-dimensions">{{item.width}}x{{item.height}}</view>
      </view>
    </scroll-view>

    <!-- é¢œè‰²é€‰æ‹© -->
    <scroll-view scroll-x class="color-list">
      <view 
        wx:for="{{colorList}}" 
        wx:key="id"
        class="color-item {{selectedColor.id === item.id ? 'active' : ''}}"
        data-color="{{item}}"
        bindtap="selectColor"
      >
        <view class="color-preview" style="background-color: {{item.value}}"></view>
        <view class="color-name">{{item.name}}</view>
      </view>
    </scroll-view>

    <!-- é€‰æ‹©å›¾ç‰‡æŒ‰é’® -->
    <view class="upload-btn" bindtap="uploadTap">
      <view class="upload-icon">ğŸ“·</view>
      <text>ä¸Šä¼ ç…§ç‰‡</text>
    </view>
  </view>

  <!-- æ­¥éª¤2ï¼šå¤„ç†èƒŒæ™¯ -->
  <view class="step-2" wx:if="{{step === 2}}">
    <view class="processing">
      <view class="loading"></view>
      <text>æ­£åœ¨æ™ºèƒ½æŠ å›¾...</text>
    </view>
  </view>

  <!-- æ­¥éª¤3ï¼šè£å‰ª -->
  <view class="step-3" wx:if="{{step === 3}}">
    <!-- è£å‰ªåŒºåŸŸ -->
    <view class="cropper-wrapper">
      <template is="we-cropper" data="{{...cropperOpt}}"/>
    </view>

    <!-- åº•éƒ¨æ“ä½œåŒº -->
    <view class="footer">
      <view class="footer-btn" bindtap="showSizePopup">
        <view class="btn-icon">ğŸ“</view>
        <text>æ›´æ¢å°ºå¯¸</text>
      </view>
      <view class="footer-btn" bindtap="showColorPopup">
        <view class="btn-icon">ğŸ¨</view>
        <text>æ›´æ¢èƒŒæ™¯</text>
      </view>
      <view class="footer-btn" bindtap="uploadTap">
        <view class="btn-icon">ğŸ“·</view>
        <text>æ›´æ¢å›¾ç‰‡</text>
      </view>
      <view class="footer-btn" bindtap="saveResult">
        <view class="btn-icon">ğŸ’¾</view>
        <text>ä¿å­˜å›¾ç‰‡</text>
      </view>
    </view>
  </view>

  <!-- ç»“æœç”»å¸ƒ -->
  <canvas 
    type="2d"
    id="resultCanvas" 
    class="result-canvas"
  ></canvas>

  <!-- å¼¹å‡ºå±‚æ”¾åœ¨æœ€å¤–å±‚ä»¥ç¡®ä¿åœ¨æœ€ä¸Šå±‚æ˜¾ç¤º -->
  <!-- å°ºå¯¸é€‰æ‹©å¼¹å‡ºå±‚ -->
  <view class="popup-mask" wx:if="{{showSizePopup}}" bindtap="hideSizePopup"></view>
  <view class="popup-content {{showSizePopup ? 'popup-show' : ''}}" wx:if="{{showSizePopup}}">
    <view class="popup-header">
      <text>é€‰æ‹©å°ºå¯¸</text>
      <view class="popup-close" bindtap="hideSizePopup">âœ–ï¸</view>
    </view>
    <view class="popup-body">
      <view 
        wx:for="{{sizeList}}" 
        wx:key="id"
        class="size-item {{selectedSize.id === item.id ? 'active' : ''}}"
        data-size="{{item}}"
        bindtap="selectSize"
      >
        <view class="size-name">{{item.name}}</view>
        <view class="size-dimensions">{{item.width}}x{{item.height}}</view>
      </view>
    </view>
  </view>

  <!-- èƒŒæ™¯è‰²é€‰æ‹©å¼¹å‡ºå±‚ -->
  <view class="popup-mask" wx:if="{{showColorPopup}}" bindtap="hideColorPopup"></view>
  <view class="popup-content {{showColorPopup ? 'popup-show' : ''}}" wx:if="{{showColorPopup}}">
    <view class="popup-header">
      <text>é€‰æ‹©èƒŒæ™¯è‰²</text>
      <view class="popup-close" bindtap="hideColorPopup">âœ–ï¸</view>
    </view>
    <view class="popup-body">
      <view 
        wx:for="{{colorList}}" 
        wx:key="id"
        class="color-item {{selectedColor.id === item.id ? 'active' : ''}}"
        data-color="{{item}}"
        bindtap="selectColor"
      >
        <view class="color-preview" style="background-color: {{item.value}}"></view>
        <view class="color-name">{{item.name}}</view>
      </view>
    </view>
  </view>
</view>